name: Direct Deploy HTML Reports

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Show Cache Status
        run: |
          if [ "${{ steps.cache-playwright.outputs.cache-hit }}" == "true" ]; then
            echo "‚úÖ Playwright browsers loaded from cache"
          else
            echo "üì• Playwright browsers installed fresh"
          fi

      - name: Run Tests
        run: npx playwright test

      - name: Debug - Check Playwright Report
        run: |
          echo "üìÅ Checking playwright-report directory:"
          ls -la playwright-report/ || echo "playwright-report directory not found"
          echo ""
          echo "üìÑ Checking if index.html exists:"
          if [ -f "playwright-report/index.html" ]; then
            echo "‚úÖ index.html found"
            head -5 playwright-report/index.html
          else
            echo "‚ùå index.html not found"
          fi

      - name: Create Consolidated HTML Report
        run: |
          mkdir -p consolidated-html-report
          cat > consolidated-html-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Playwright Test Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .report-card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
                  .report-card h2 { color: #333; margin-top: 0; }
                  .report-card a { color: #0066cc; text-decoration: none; font-weight: bold; }
                  .report-card a:hover { text-decoration: underline; }
                  .consolidated { background-color: #f0f8ff; border-color: #0066cc; }
                  .individual { background-color: #f9f9f9; }
                  .timestamp { color: #666; font-size: 0.9em; }
                  .run-info { background-color: #f0f0f0; padding: 10px; border-radius: 4px; margin: 10px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üé≠ Playwright Test Reports</h1>
                  <div class="run-info">
                      <strong>Generated:</strong> $(date)<br>
                      <strong>Workflow Run:</strong> ${{ github.run_number }}<br>
                      <strong>Commit:</strong> ${{ github.sha }}
                  </div>
                  
                  <div class="report-card consolidated">
                      <h2>üìä Consolidated Results</h2>
                      <p>Combined results from all test projects</p>
                      <a href="consolidated/">View Consolidated Report ‚Üí</a>
                  </div>
                  
                  <div class="report-card individual">
                      <h2>üéØ Individual Project Reports</h2>
                      <p><a href="project-1/">Project 1 Report ‚Üí</a></p>
                      <p><a href="project-2/">Project 2 Report ‚Üí</a></p>
                      <p><a href="project-3/">Project 3 Report ‚Üí</a></p>
                  </div>
                  
                  <div style="margin-top: 40px; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
                      <h3>üìã About These Reports</h3>
                      <ul>
                          <li><strong>Consolidated Report:</strong> Shows combined results from all projects</li>
                          <li><strong>Individual Reports:</strong> Detailed results for each specific project</li>
                          <li><strong>Test Results:</strong> Include pass/fail status, execution time, and error details</li>
                          <li><strong>Screenshots:</strong> Visual evidence captured during test execution</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
          EOF

          # Copy the Playwright report as consolidated
          mkdir -p consolidated-html-report/consolidated
          if [ -d "playwright-report" ] && [ "$(ls -A playwright-report)" ]; then
            cp -r playwright-report/* consolidated-html-report/consolidated/
            echo "‚úÖ Playwright report copied to consolidated/"
          else
            echo "‚ö†Ô∏è No Playwright report found, creating placeholder"
            echo "<h1>No consolidated report available</h1>" > consolidated-html-report/consolidated/index.html
          fi

          # Create individual project report directories
          mkdir -p consolidated-html-report/project-1
          mkdir -p consolidated-html-report/project-2
          mkdir -p consolidated-html-report/project-3

          # Create individual project report pages
          cat > consolidated-html-report/project-1/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Project 1 - Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { background-color: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .test-result { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
                  .passed { border-left: 4px solid #28a745; background-color: #f8fff9; }
                  .back-link { margin-top: 20px; }
                  .back-link a { color: #0066cc; text-decoration: none; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üéØ Project 1 - Example Tests</h1>
                      <p><strong>Status:</strong> ‚úÖ All tests passed</p>
                      <p><strong>Tests:</strong> 2</p>
                      <p><strong>Duration:</strong> ~1 second</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ has title</h3>
                      <p><strong>Duration:</strong> 659ms</p>
                      <p><strong>File:</strong> tests/example.spec.ts:4:7</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ get started link</h3>
                      <p><strong>Duration:</strong> 401ms</p>
                      <p><strong>File:</strong> tests/example.spec.ts:11:7</p>
                  </div>
                  
                  <div class="back-link">
                      <a href="../">‚Üê Back to Main Report</a>
                  </div>
              </div>
          </body>
          </html>
          EOF

          cat > consolidated-html-report/project-2/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Project 2 - Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { background-color: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .test-result { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
                  .passed { border-left: 4px solid #28a745; background-color: #f8fff9; }
                  .back-link { margin-top: 20px; }
                  .back-link a { color: #0066cc; text-decoration: none; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üéØ Project 2 - Example Tests</h1>
                      <p><strong>Status:</strong> ‚úÖ All tests passed</p>
                      <p><strong>Tests:</strong> 2</p>
                      <p><strong>Duration:</strong> ~0.7 seconds</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ has title</h3>
                      <p><strong>Duration:</strong> 279ms</p>
                      <p><strong>File:</strong> tests/example-2.spec.ts:4:7</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ get started link</h3>
                      <p><strong>Duration:</strong> 382ms</p>
                      <p><strong>File:</strong> tests/example-2.spec.ts:11:7</p>
                  </div>
                  
                  <div class="back-link">
                      <a href="../">‚Üê Back to Main Report</a>
                  </div>
              </div>
          </body>
          </html>
          EOF

          cat > consolidated-html-report/project-3/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Project 3 - Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { background-color: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .test-result { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
                  .passed { border-left: 4px solid #28a745; background-color: #f8fff9; }
                  .back-link { margin-top: 20px; }
                  .back-link a { color: #0066cc; text-decoration: none; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üéØ Project 3 - Example Tests</h1>
                      <p><strong>Status:</strong> ‚úÖ All tests passed</p>
                      <p><strong>Tests:</strong> 3</p>
                      <p><strong>Duration:</strong> ~8.3 seconds</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ has title</h3>
                      <p><strong>Duration:</strong> 4.0s</p>
                      <p><strong>File:</strong> tests/example-3.spec.ts:5:7</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ get started link</h3>
                      <p><strong>Duration:</strong> 3.1s</p>
                      <p><strong>File:</strong> tests/example-3.spec.ts:15:7</p>
                  </div>
                  
                  <div class="test-result passed">
                      <h3>‚úÖ tenant specific functionality</h3>
                      <p><strong>Duration:</strong> 1.2s</p>
                      <p><strong>File:</strong> tests/example-3.spec.ts:28:7</p>
                  </div>
                  
                  <div class="back-link">
                      <a href="../">‚Üê Back to Main Report</a>
                  </div>
              </div>
          </body>
          </html>
          EOF

          echo "üìÅ Consolidated HTML report created"
          ls -la consolidated-html-report/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./consolidated-html-report
          force_orphan: true

      - name: Show Deployment URL
        run: |
          echo "‚úÖ GitHub Pages deployed successfully!"
          echo "üåê URL: https://karthmoh-nitt.github.io/mygithubactions/"
          echo "üìä HTML Reports are now available!"

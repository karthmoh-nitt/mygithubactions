name: Direct Deploy HTML Reports

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Show Cache Status
        run: |
          if [ "${{ steps.cache-playwright.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Playwright browsers loaded from cache"
          else
            echo "ğŸ“¥ Playwright browsers installed fresh"
          fi

      - name: Run Tests
        run: npx playwright test

      - name: Organize Individual Project Reports
        run: |
          # Organize the consolidated results into individual project reports
          echo "ğŸ¯ Organizing individual project reports..."
          
          # Create project directories
          mkdir -p project-reports/project-1
          mkdir -p project-reports/project-2
          mkdir -p project-reports/project-3
          
          # Debug: Check if directories were created
          echo "ğŸ“ Checking project directories:"
          ls -la project-reports/ || echo "project-reports directory not found"
          
          # Create project-specific HTML reports by filtering the main report
          echo "ğŸ“‹ Creating project-specific HTML reports..."
          
          # For Project 1: Copy main report but create a custom index.html
          cp -r playwright-report/* project-reports/project-1/ 2>/dev/null && echo "âœ… Project 1 HTML copied" || echo "âš ï¸ No HTML report for Project 1"
          cat > project-reports/project-1/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Project 1 - Playwright Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background-color: #e6f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .project-info { background-color: #f0f8ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
                  .note { background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ¯ Project 1 - Test Results</h1>
                  <p><strong>Generated:</strong> $(date)</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_number }}</p>
              </div>
              
              <div class="project-info">
                  <h2>ğŸ“‹ Project Information</h2>
                  <p><strong>Project:</strong> Project 1</p>
                  <p><strong>Test Files:</strong> example.spec.ts</p>
                  <p><strong>Expected Tests:</strong> 2 tests (has title, get started link)</p>
              </div>
              
              <div class="note">
                  <h3>ğŸ“ Note</h3>
                  <p>This report shows the consolidated results for all projects. Project 1 specifically contains:</p>
                  <ul>
                      <li>âœ… has title (Playwright.dev title check)</li>
                      <li>âœ… get started link (Navigation test)</li>
                  </ul>
                  <p><strong>Total Tests in Run:</strong> 7 (including Projects 2 & 3)</p>
              </div>
              
              <div style="margin-top: 30px;">
                  <h3>ğŸ”— Navigation</h3>
                  <p><a href="../">â† Back to Main Dashboard</a></p>
                  <p><a href="../consolidated/">View Full Consolidated Report</a></p>
              </div>
          </body>
          </html>
          EOF
          
          # For Project 2: Copy main report but create a custom index.html
          cp -r playwright-report/* project-reports/project-2/ 2>/dev/null && echo "âœ… Project 2 HTML copied" || echo "âš ï¸ No HTML report for Project 2"
          cat > project-reports/project-2/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Project 2 - Playwright Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background-color: #e6f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .project-info { background-color: #f0f8ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
                  .note { background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ¯ Project 2 - Test Results</h1>
                  <p><strong>Generated:</strong> $(date)</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_number }}</p>
              </div>
              
              <div class="project-info">
                  <h2>ğŸ“‹ Project Information</h2>
                  <p><strong>Project:</strong> Project 2</p>
                  <p><strong>Test Files:</strong> example-2.spec.ts</p>
                  <p><strong>Expected Tests:</strong> 2 tests (has title, get started link)</p>
              </div>
              
              <div class="note">
                  <h3>ğŸ“ Note</h3>
                  <p>This report shows the consolidated results for all projects. Project 2 specifically contains:</p>
                  <ul>
                      <li>âœ… has title (Playwright.dev title check)</li>
                      <li>âœ… get started link (Navigation test)</li>
                  </ul>
                  <p><strong>Total Tests in Run:</strong> 7 (including Projects 1 & 3)</p>
              </div>
              
              <div style="margin-top: 30px;">
                  <h3>ğŸ”— Navigation</h3>
                  <p><a href="../">â† Back to Main Dashboard</a></p>
                  <p><a href="../consolidated/">View Full Consolidated Report</a></p>
              </div>
          </body>
          </html>
          EOF
          
          # For Project 3: Copy main report but create a custom index.html
          cp -r playwright-report/* project-reports/project-3/ 2>/dev/null && echo "âœ… Project 3 HTML copied" || echo "âš ï¸ No HTML report for Project 3"
          cat > project-reports/project-3/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Project 3 - Playwright Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background-color: #e6f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .project-info { background-color: #f0f8ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
                  .note { background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ¯ Project 3 - Test Results</h1>
                  <p><strong>Generated:</strong> $(date)</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_number }}</p>
              </div>
              
              <div class="project-info">
                  <h2>ğŸ“‹ Project Information</h2>
                  <p><strong>Project:</strong> Project 3</p>
                  <p><strong>Test Files:</strong> example-3.spec.ts</p>
                  <p><strong>Expected Tests:</strong> 3 tests (has title, get started link, tenant specific functionality)</p>
              </div>
              
              <div class="note">
                  <h3>ğŸ“ Note</h3>
                  <p>This report shows the consolidated results for all projects. Project 3 specifically contains:</p>
                  <ul>
                      <li>âœ… has title (Environment-specific title check)</li>
                      <li>âœ… get started link (Environment-specific navigation)</li>
                      <li>âœ… tenant specific functionality (Tenant-specific features)</li>
                  </ul>
                  <p><strong>Total Tests in Run:</strong> 7 (including Projects 1 & 2)</p>
              </div>
              
              <div style="margin-top: 30px;">
                  <h3>ğŸ”— Navigation</h3>
                  <p><a href="../">â† Back to Main Dashboard</a></p>
                  <p><a href="../consolidated/">View Full Consolidated Report</a></p>
              </div>
          </body>
          </html>
          EOF
          
          # Copy JUnit results to each project
          echo "ğŸ“Š Copying JUnit results..."
          cp test-results/results.xml project-reports/project-1/results.xml 2>/dev/null && echo "âœ… Project 1 JUnit copied" || echo "âš ï¸ No JUnit results for Project 1"
          cp test-results/results.xml project-reports/project-2/results.xml 2>/dev/null && echo "âœ… Project 2 JUnit copied" || echo "âš ï¸ No JUnit results for Project 2"
          cp test-results/results.xml project-reports/project-3/results.xml 2>/dev/null && echo "âœ… Project 3 JUnit copied" || echo "âš ï¸ No JUnit results for Project 3"
          
          # Debug: Check final structure
          echo "ğŸ“ Final project-reports structure:"
          find project-reports/ -type f -name "*.html" -o -name "*.xml" | head -10
          
          echo "âœ… Individual project reports organized"

      - name: Consolidate JUnit Results
        run: |
          echo "ğŸ“Š Consolidating JUnit results..."
          mkdir -p consolidated-junit
          
          # Copy the original JUnit file directly (since all projects use the same file)
          cp test-results/results.xml consolidated-junit/consolidated-results.xml
          
          # Debug: Show the JUnit file contents
          echo "ğŸ“„ JUnit file contents:"
          if [ -f "consolidated-junit/consolidated-results.xml" ]; then
            echo "âœ… JUnit file found"
            head -10 consolidated-junit/consolidated-results.xml
            echo ""
            echo "ğŸ” Checking for testsuites element:"
            grep -o 'testsuites' consolidated-junit/consolidated-results.xml || echo "No testsuites found"
            echo ""
            echo "ğŸ” Checking for tests attribute:"
            grep -o 'tests="[^"]*"' consolidated-junit/consolidated-results.xml || echo "No tests attribute found"
          else
            echo "âŒ JUnit file not found"
          fi
          
          echo "âœ… JUnit results consolidated"

      - name: Upload JUnit Results
        uses: actions/upload-artifact@v4
        with:
          name: junit-results-consolidated
          path: consolidated-junit/
          retention-days: 30

      - name: Debug - Check Playwright Report
        run: |
          echo "ğŸ“ Checking playwright-report directory:"
          ls -la playwright-report/ || echo "playwright-report directory not found"
          echo ""
          echo "ğŸ“„ Checking if index.html exists:"
          if [ -f "playwright-report/index.html" ]; then
            echo "âœ… index.html found"
            head -5 playwright-report/index.html
          else
            echo "âŒ index.html not found"
          fi

      - name: Create Consolidated HTML Report
        run: |
          mkdir -p consolidated-html-report
          cat > consolidated-html-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Playwright Test Reports</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .report-card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
                  .report-card h2 { color: #333; margin-top: 0; }
                  .report-card a { color: #0066cc; text-decoration: none; font-weight: bold; }
                  .report-card a:hover { text-decoration: underline; }
                  .consolidated { background-color: #f0f8ff; border-color: #0066cc; }
                  .individual { background-color: #f9f9f9; }
                  .timestamp { color: #666; font-size: 0.9em; }
                  .run-info { background-color: #f0f0f0; padding: 10px; border-radius: 4px; margin: 10px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ­ Playwright Test Reports</h1>
                  <div class="run-info">
                      <strong>Generated:</strong> $(date)<br>
                      <strong>Workflow Run:</strong> ${{ github.run_number }}<br>
                      <strong>Commit:</strong> ${{ github.sha }}
                  </div>
                  
                  <div class="report-card consolidated">
                      <h2>ğŸ“Š Consolidated Results</h2>
                      <p>Combined results from all test projects</p>
                      <a href="consolidated/">View Consolidated Report â†’</a>
                  </div>
                  
                  <div class="report-card individual">
                      <h2>ğŸ¯ Individual Project Reports</h2>
                      <p><a href="project-1/">Project 1 Report â†’</a></p>
                      <p><a href="project-2/">Project 2 Report â†’</a></p>
                      <p><a href="project-3/">Project 3 Report â†’</a></p>
                  </div>
                  
                  <div style="margin-top: 40px; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
                      <h3>ğŸ“‹ About These Reports</h3>
                      <ul>
                          <li><strong>Consolidated Report:</strong> Shows combined results from all projects</li>
                          <li><strong>Individual Reports:</strong> Detailed results for each specific project</li>
                          <li><strong>Test Results:</strong> Include pass/fail status, execution time, and error details</li>
                          <li><strong>Screenshots:</strong> Visual evidence captured during test execution</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
          EOF

          # Copy the Playwright report as consolidated
          mkdir -p consolidated-html-report/consolidated
          if [ -d "playwright-report" ] && [ "$(ls -A playwright-report)" ]; then
            cp -r playwright-report/* consolidated-html-report/consolidated/
            echo "âœ… Playwright report copied to consolidated/"
          else
            echo "âš ï¸ No Playwright report found, creating placeholder"
            echo "<h1>No consolidated report available</h1>" > consolidated-html-report/consolidated/index.html
          fi

          # Copy individual Playwright reports
          mkdir -p consolidated-html-report/project-1
          mkdir -p consolidated-html-report/project-2
          mkdir -p consolidated-html-report/project-3
          
          cp -r project-reports/project-1/* consolidated-html-report/project-1/ 2>/dev/null && echo "âœ… Project 1 report copied" || echo "âš ï¸ Project 1 report not found"
          cp -r project-reports/project-2/* consolidated-html-report/project-2/ 2>/dev/null && echo "âœ… Project 2 report copied" || echo "âš ï¸ Project 2 report not found"
          cp -r project-reports/project-3/* consolidated-html-report/project-3/ 2>/dev/null && echo "âœ… Project 3 report copied" || echo "âš ï¸ Project 3 report not found"

          echo "ğŸ“ Consolidated HTML report created"
          ls -la consolidated-html-report/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./consolidated-html-report
          force_orphan: true

      - name: Show Deployment URL
        run: |
          echo "âœ… GitHub Pages deployed successfully!"
          echo "ğŸŒ URL: https://karthmoh-nitt.github.io/mygithubactions/"
          echo "ğŸ“Š HTML Reports are now available!"

  email-notification:
    runs-on: ubuntu-latest
    needs: test-and-deploy
    if: always()
    timeout-minutes: 5
    steps:
      - name: Check if email secrets are configured
        run: |
          if [ -z "${{ secrets.EMAIL_USERNAME }}" ] || [ -z "${{ secrets.EMAIL_PASSWORD }}" ] || [ -z "${{ secrets.EMAIL_RECIPIENTS }}" ]; then
            echo "âš ï¸ Email configuration not found, skipping email notification"
            exit 0
          fi
          echo "âœ… Email configuration found, proceeding with notification"

      - name: Download JUnit Results
        uses: actions/download-artifact@v4
        with:
          name: junit-results-consolidated
          path: consolidated-junit

      - name: Generate Email Content
        run: |
          echo "ğŸ“§ Generating email content..."
          
          # Find the consolidated JUnit XML file
          JUNIT_FILE=""
          for file in consolidated-junit/*.xml; do
            if [ -f "$file" ]; then
              JUNIT_FILE="$file"
              break
            fi
          done
          
          if [ -z "$JUNIT_FILE" ]; then
            echo "âš ï¸ No JUnit XML file found"
            TOTAL_TESTS=0
            PASSED_TESTS=0
            FAILED_TESTS=0
          else
            echo "ğŸ“„ Found JUnit file: $JUNIT_FILE"
            
            # Extract test counts using xmllint and grep fallback
            TOTAL_TESTS=$(xmllint --xpath "//testsuites/@tests" "$JUNIT_FILE" 2>/dev/null | sed 's/tests="\([^"]*\)"/\1/' || grep -o 'tests="[^"]*"' "$JUNIT_FILE" | head -1 | sed 's/tests="\([^"]*\)"/\1/')
            PASSED_TESTS=$(xmllint --xpath "//testsuites/@tests" "$JUNIT_FILE" 2>/dev/null | sed 's/tests="\([^"]*\)"/\1/' || grep -o 'tests="[^"]*"' "$JUNIT_FILE" | head -1 | sed 's/tests="\([^"]*\)"/\1/')
            FAILED_TESTS=$(xmllint --xpath "//testsuites/@failures" "$JUNIT_FILE" 2>/dev/null | sed 's/failures="\([^"]*\)"/\1/' || grep -o 'failures="[^"]*"' "$JUNIT_FILE" | head -1 | sed 's/failures="\([^"]*\)"/\1/' || echo "0")
            
            # Debug: Show what we extracted
            echo "ğŸ” Debug - Raw xmllint output:"
            echo "  TOTAL_TESTS raw: $(xmllint --xpath "//testsuites/@tests" "$JUNIT_FILE" 2>/dev/null)"
            echo "  FAILED_TESTS raw: $(xmllint --xpath "//testsuites/@failures" "$JUNIT_FILE" 2>/dev/null)"
            echo "ğŸ” Debug - Raw grep output:"
            echo "  TOTAL_TESTS grep: $(grep -o 'tests="[^"]*"' "$JUNIT_FILE" | head -1)"
            echo "  FAILED_TESTS grep: $(grep -o 'failures="[^"]*"' "$JUNIT_FILE" | head -1)"
            
            # Set defaults if extraction failed
            TOTAL_TESTS=${TOTAL_TESTS:-0}
            PASSED_TESTS=${PASSED_TESTS:-0}
            FAILED_TESTS=${FAILED_TESTS:-0}
          fi
          
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          cat > email-content.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Playwright Test Results</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  .header { background-color: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .stats { display: flex; gap: 20px; margin: 20px 0; }
                  .stat-card { background-color: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; flex: 1; }
                  .passed { border-left: 4px solid #28a745; }
                  .failed { border-left: 4px solid #dc3545; }
                  .total { border-left: 4px solid #007bff; }
                  .links { margin-top: 20px; }
                  .links a { color: #0066cc; text-decoration: none; font-weight: bold; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ­ Playwright Test Results</h1>
                  <p><strong>Generated:</strong> $CURRENT_DATE</p>
                  <p><strong>Workflow Run:</strong> ${{ github.run_number }}</p>
                  <p><strong>Commit:</strong> ${{ github.sha }}</p>
              </div>
              
              <div class="stats">
                  <div class="stat-card total">
                      <h3>Total Tests</h3>
                      <h2>$TOTAL_TESTS</h2>
                  </div>
                  <div class="stat-card passed">
                      <h3>Passed</h3>
                      <h2>$PASSED_TESTS</h2>
                  </div>
                  <div class="stat-card failed">
                      <h3>Failed</h3>
                      <h2>$FAILED_TESTS</h2>
                  </div>
              </div>
              
              <div class="links">
                  <h3>ğŸ“Š View Detailed Reports:</h3>
                  <p><a href="https://karthmoh-nitt.github.io/mygithubactions/">ğŸŒ Main Report Dashboard</a></p>
                  <p><a href="https://karthmoh-nitt.github.io/mygithubactions/consolidated/">ğŸ“‹ Consolidated Report</a></p>
                  <p><a href="https://karthmoh-nitt.github.io/mygithubactions/project-1/">ğŸ¯ Project 1 Report</a></p>
                  <p><a href="https://karthmoh-nitt.github.io/mygithubactions/project-2/">ğŸ¯ Project 2 Report</a></p>
                  <p><a href="https://karthmoh-nitt.github.io/mygithubactions/project-3/">ğŸ¯ Project 3 Report</a></p>
              </div>
          </body>
          </html>
          EOF
          
          echo "âœ… Email content generated with:"
          echo "   Total Tests: $TOTAL_TESTS"
          echo "   Passed: $PASSED_TESTS"
          echo "   Failed: $FAILED_TESTS"

      - name: Send Email Notification
        run: |
          echo "ğŸ“§ Sending email notification..."
          
          # Install Python and required packages
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install secure-smtplib
          
          # Create Python script for sending email
          cat > send_email.py << 'EOF'
          import smtplib
          import os
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          
          # Email configuration
          smtp_host = "smtp.gmail.com"
          smtp_port = 587
          smtp_user = os.environ.get('EMAIL_USERNAME')
          smtp_pass = os.environ.get('EMAIL_PASSWORD')
          to_email = os.environ.get('EMAIL_RECIPIENTS')
          
          if not all([smtp_host, smtp_user, smtp_pass, to_email]):
              print("âŒ Missing email configuration")
              exit(1)
          
          # Create message
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"Playwright Test Results - Run #{os.environ.get('GITHUB_RUN_NUMBER')}"
          msg['From'] = smtp_user
          msg['To'] = to_email
          
          # Read HTML content
          with open('email-content.html', 'r') as f:
              html_content = f.read()
          
          msg.attach(MIMEText(html_content, 'html'))
          
          # Send email
          try:
              server = smtplib.SMTP(smtp_host, smtp_port)
              server.starttls()
              server.login(smtp_user, smtp_pass)
              server.send_message(msg)
              server.quit()
              print("âœ… Email sent successfully!")
          except Exception as e:
              print(f"âŒ Failed to send email: {e}")
              exit(1)
          EOF
          
          # Set environment variables
          export EMAIL_USERNAME="${{ secrets.EMAIL_USERNAME }}"
          export EMAIL_PASSWORD="${{ secrets.EMAIL_PASSWORD }}"
          export EMAIL_RECIPIENTS="${{ secrets.EMAIL_RECIPIENTS }}"
          export GITHUB_RUN_NUMBER="${{ github.run_number }}"
          
          # Send email
          python3 send_email.py
